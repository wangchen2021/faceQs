# WebRTC 核心介绍文档
## 一、 什么是 WebRTC
WebRTC（Web Real-Time Communication，网页实时通信）是一套**由 Google 主导推动的浏览器原生技术标准（API 集合）**，无需安装任何第三方插件、客户端或额外软件，仅通过浏览器即可实现低延迟、点对点的实时音视频通信和数据传输。

其核心目标是让 Web 应用具备“实时交互”能力，打破传统网页只能做静态展示或异步数据交互的限制，为在线会议、视频通话、在线教育、实时协作等场景提供轻量化解决方案。

## 二、 WebRTC 核心特性
1.  **浏览器原生支持**：现代主流浏览器（Chrome、Edge、Firefox、Safari）均内置 WebRTC 引擎，无需额外部署插件（如 Flash），开箱即用。
2.  **低延迟传输**：采用点对点（P2P）直连模式（特殊场景除外），无需经过服务器中转媒体流，延迟可低至几十到几百毫秒，满足实时交互需求。
3.  **跨平台兼容**：支持 Windows、Mac、Linux 桌面端，以及 iOS、Android 移动端，同时可通过封装适配 Electron、React Native 等跨平台框架。
4.  **功能完备性**：内置音视频采集、编码/解码、降噪、回声消除、带宽自适应等能力，无需手动集成第三方音视频处理库。
5.  **双向数据传输**：除音视频外，还支持通用数据的点对点传输（RTCDataChannel），可用于实时文字聊天、文件传输、游戏数据同步等场景。
6.  **安全可靠**：默认采用 DTLS（Datagram Transport Layer Security）加密传输媒体流和数据，保障通信内容的安全性和完整性。

## 三、 WebRTC 核心组成（三大核心 API）
WebRTC 的功能通过三组核心 API 实现，覆盖“音视频采集-连接建立-媒体/数据传输”全链路：

### 1.  媒体采集 API：`MediaDevices`
用于采集本地设备的音视频流（摄像头、麦克风），核心方法为 `getUserMedia`，是 WebRTC 所有音视频场景的基础。
-  核心功能：获取本地媒体流（MediaStream），可配置视频分辨率、帧率、音频采样率等参数。
-  关键特性：需要用户授权设备访问权限，支持音视频单独采集或同时采集。
-  简单示例：
  ```javascript
  // 配置采集参数
  const constraints = {
    video: { width: 1280, height: 720, frameRate: 30 }, // 720P 30帧
    audio: true // 开启音频采集
  };

  // 获取本地音视频流
  navigator.mediaDevices.getUserMedia(constraints)
    .then(stream => {
      // 将流绑定到 video 元素预览
      const video = document.getElementById('localVideo');
      video.srcObject = stream;
    })
    .catch(err => {
      console.error('采集失败：', err); // 处理权限拒绝、无设备等异常
    });
  ```

### 2.  点对点连接 API：`RTCPeerConnection`
WebRTC 的核心 API，用于建立两个客户端之间的点对点连接，负责媒体流的协商、传输和管理。
-  核心功能：
  -  协商音视频编码格式、传输参数（通过 SDP 交换）；
  -  获取网络候选地址（ICE 候选），解决内网穿透问题；
  -  添加本地媒体流、监听远端媒体流；
  -  管理连接状态（建立、断开、失败等）。
-  关键依赖：需要 STUN/TURN 服务器辅助（解决内网穿透），需要信令服务器辅助（交换 SDP 和 ICE 信息）。
-  核心流程：
  1.  创建 `RTCPeerConnection` 实例（配置 STUN/TURN 服务器）；
  2.  添加本地媒体流到连接实例；
  3.  创建 Offer（发起方）/ Answer（接收方），并通过信令服务器交换；
  4.  交换 ICE 候选地址，建立网络连接；
  5.  监听远端媒体流，实现音视频播放。

### 3.  数据通道 API：`RTCDataChannel`
用于实现点对点的通用数据传输，与音视频流独立，可传输任意格式的数据（文本、二进制、文件等）。
-  核心功能：双向、低延迟的数据传输，支持可靠传输（类似 TCP）和不可靠传输（类似 UDP）。
-  适用场景：实时文字聊天、白板协作数据同步、小型文件传输、游戏实时数据交互。
-  简单示例：
  ```javascript
  // 基于 RTCPeerConnection 创建数据通道
  const peerConnection = new RTCPeerConnection(iceConfig);
  const dataChannel = peerConnection.createDataChannel('chat'); // 命名为 chat

  // 监听数据通道消息
  dataChannel.onmessage = (event) => {
    console.log('收到数据：', event.data);
  };

  // 发送数据
  dataChannel.send('Hello WebRTC!');
  ```

## 四、 WebRTC 核心工作流程（点对点音视频通话）
WebRTC 实现点对点音视频通话的核心流程可分为 5 步，其中**信令交换**和**内网穿透**是关键环节：

### 步骤 1： 本地音视频采集
通过 `MediaDevices.getUserMedia` 获取本地摄像头/麦克风流，实现本地预览。

### 步骤 2： 信令交换（核心辅助环节）
WebRTC 本身不提供信令传输能力，需借助外部信令服务器（如 Socket.IO、WebSocket、MQTT 等）交换两类核心信息：
1.  **SDP（Session Description Protocol，会话描述协议）**：包含音视频编码格式、设备信息、会话类型（Offer/Answer）等，用于双方协商通信参数；
2.  **ICE（Interactive Connectivity Establishment，交互式连接建立）**：包含客户端的内网 IP、公网 IP 等网络候选地址，用于建立点对点网络连接。

#### 信令交换流程（一对一通话）
1.  客户端 A（发起方）创建 `RTCPeerConnection` 实例，生成 Offer（SDP）；
2.  客户端 A 通过信令服务器将 Offer 发送给客户端 B；
3.  客户端 B（接收方）收到 Offer 后，创建 `RTCPeerConnection` 实例，生成 Answer（SDP）；
4.  客户端 B 通过信令服务器将 Answer 发送给客户端 A；
5.  双方互相保存对方的 SDP，完成通信参数协商。

### 步骤 3： ICE 候选地址交换
1.  双方 `RTCPeerConnection` 实例通过 STUN 服务器获取自身公网地址，生成 ICE 候选地址；
2.  双方通过信令服务器互相转发 ICE 候选地址；
3.  双方尝试通过 ICE 候选地址建立点对点连接（优先选择直连，直连失败则通过 TURN 服务器中转）。

### 步骤 4： 点对点连接建立
当双方完成 SDP 和 ICE 信息交换后，`RTCPeerConnection` 会自动建立点对点连接，此时媒体流无需经过服务器中转，直接在客户端之间传输。

### 步骤 5： 远端音视频播放与连接管理
1.  客户端通过 `RTCPeerConnection.ontrack` 事件监听远端媒体流；
2.  将远端媒体流绑定到 `video` 元素，实现实时播放；
3.  监听连接状态变化（`onconnectionstatechange`），处理连接断开、失败等异常场景；
4.  通话结束后，释放媒体流、关闭 `RTCPeerConnection` 实例，清理资源。

## 五、 WebRTC 关键依赖服务
WebRTC 并非完全“无服务器”，需要两类辅助服务器来保障正常运行：

### 1.  信令服务器
-  **核心作用**：交换 SDP 和 ICE 信息，同时可用于房间管理、用户上线/下线通知等业务逻辑；
-  **技术选型**：Socket.IO（推荐，易用性高）、原生 WebSocket、MQTT、REST API（不推荐，延迟较高）；
-  **部署特点**：轻量级，无需高性能配置，可部署在普通云服务器上。

### 2.  STUN/TURN 服务器
#### （1） STUN 服务器
-  **核心作用**：帮助内网客户端获取自身公网 IP 地址和端口，实现内网设备的点对点直连；
-  **特点**：无状态，仅负责地址转换查询，不中转媒体流，部署简单，可使用公共 STUN 服务器（无需自建）；
-  **公共 STUN 服务器示例**：
  -  谷歌：`stun:stun.l.google.com:19302`
  -  腾讯：`stun:stun.qq.com:3478`
  -  阿里云：`stun:stun.aliyun.com:3478`

#### （2） TURN 服务器
-  **核心作用**：当客户端无法实现点对点直连时（如双方均在严格内网环境），作为中转服务器转发媒体流，保障通信不中断；
-  **特点**：有状态，需要中转媒体流，对服务器带宽和性能要求较高；
-  **开源实现**：coturn（主流开源 TURN 服务器，支持跨平台部署）。

## 六、 WebRTC 适用场景
1.  **音视频通信类**：在线会议（如 Zoom、腾讯会议网页版）、一对一视频通话、在线客服视频咨询、语音通话。
2.  **在线教育类**：一对一辅导、小班课互动、远程实验直播、师生连麦答疑。
3.  **实时协作类**：在线白板协作、文档实时编辑、远程桌面控制、团队实时沟通。
4.  **娱乐互动类**：直播连麦、在线K歌、实时游戏对战、虚拟社交场景。
5.  **行业解决方案**：远程医疗问诊、安防监控实时预览、物联网设备实时数据传输。

## 七、 WebRTC 优势与局限性
### 优势
1.  **轻量化**：浏览器原生支持，无需安装插件/客户端，降低用户使用门槛。
2.  **低延迟**：点对点直连模式，媒体流无需服务器中转，延迟远低于 HLS、RTMP 等中转式协议。
3.  **功能强大**：内置音视频降噪、回声消除、带宽自适应等能力，无需手动集成复杂算法。
4.  **跨平台兼容**：支持全平台现代浏览器，可封装适配移动端和桌面端应用。
5.  **安全加密**：默认 DTLS 加密，保障音视频和数据传输的安全性。

### 局限性
1.  **依赖辅助服务器**：需要信令服务器、STUN/TURN 服务器支撑，增加部署成本。
2.  **内网穿透限制**：极端内网环境（如多层 NAT 转发）下，需依赖 TURN 服务器中转，增加带宽成本。
3.  **浏览器兼容性**：不支持 IE 浏览器，老旧浏览器版本可能存在功能兼容问题。
4.  **大规模并发支持弱**：点对点模式适合一对一或小范围通话，大规模并发（如万人直播）需结合 CDN 中转。
5.  **开发复杂度高**：原生 API 配置繁琐，复杂场景（如多人通话、画质切换）需大量自定义开发。

## 八、 WebRTC 常用开源框架（降低开发成本）
原生 WebRTC 开发复杂度较高，针对不同场景，有成熟的开源框架可供复用：
1.  **SimpleWebRTC**：轻量级开源框架，封装了原生 WebRTC API，快速实现一对一和多人音视频通话。
2.  **Janus Gateway**：开源媒体服务器，支持 WebRTC 网关功能，可实现多人通话、直播连麦、视频会议等场景。
3.  **Mediasoup**：高性能开源 WebRTC 媒体服务器，支持大规模多人实时通信，适用于高并发场景（如在线会议、直播连麦）。
4.  **Kurento**：开源 WebRTC 媒体服务器，提供丰富的媒体处理能力（转码、录制、混音等），支持复杂业务场景。
5.  **SRS**：高性能流媒体服务器，同时支持 RTMP、HLS、WebRTC 协议，可实现协议转换和大规模分发。

## 九、 总结
1.  WebRTC 是浏览器原生的实时通信技术，核心实现点对点低延迟音视频和数据传输；
2.  三大核心 API：`MediaDevices`（采集）、`RTCPeerConnection`（连接）、`RTCDataChannel`（数据传输）；
3.  关键依赖：信令服务器（交换 SDP/ICE）、STUN/TURN 服务器（解决内网穿透）；
4.  核心优势：轻量化、低延迟、功能完备、跨平台；核心局限：依赖辅助服务器、开发复杂度高；
5.  适用场景：在线会议、在线教育、实时协作、音视频通话等，可通过开源框架降低开发成本。